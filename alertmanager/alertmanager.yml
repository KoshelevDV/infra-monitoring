global:
  resolve_timeout: 5m

# â”€â”€ Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
templates:
  - /etc/alertmanager/templates/*.tmpl

# â”€â”€ Routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
route:
  receiver: telegram-default
  group_by: [alertname, instance, job]
  group_wait: 30s        # wait before sending first notification in a group
  group_interval: 5m     # how long to wait before sending new notifications for a group
  repeat_interval: 4h    # how long to wait before re-notifying resolved

  routes:
    # Critical alerts â€” faster, separate channel
    - matchers:
        - severity = critical
      receiver: telegram-critical
      group_wait: 10s
      repeat_interval: 1h

    # Watchdog â€” send to a separate channel (or /dev/null)
    - matchers:
        - alertname = Watchdog
      receiver: watchdog
      repeat_interval: 1m

    # Debezium WAL â€” highest priority, immediate notification
    - matchers:
        - alertname =~ "DebeziumWALLag.*|DebeziumSlotInactive.*"
      receiver: telegram-critical
      group_wait: 5s
      repeat_interval: 30m

# â”€â”€ Inhibition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# If a host is down, suppress all alerts from services on that host
inhibit_rules:
  - source_matchers:
      - alertname = HostDown
    target_matchers:
      - severity =~ "warning|critical"
    equal: [instance]

  # If PostgreSQL is down, suppress WAL/replication alerts for same instance
  - source_matchers:
      - alertname = PostgreSQLDown
    target_matchers:
      - alertname =~ "DebeziumWALLag.*|DebeziumSlotInactive.*|PostgreSQL.*"
    equal: [instance]

# â”€â”€ Receivers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
receivers:
  - name: telegram-default
    telegram_configs:
      - bot_token: "${TELEGRAM_BOT_TOKEN}"
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: HTML
        message: |
          {{ range .Alerts }}
          {{ if eq .Status "firing" }}ğŸ”´{{ else }}âœ…{{ end }} <b>{{ .Labels.alertname }}</b>
          {{ if .Labels.instance }}ğŸ“ <code>{{ .Labels.instance }}</code>{{ end }}
          {{ .Annotations.summary }}
          {{ if .Annotations.description }}<i>{{ .Annotations.description }}</i>{{ end }}
          {{ end }}

  - name: telegram-critical
    telegram_configs:
      - bot_token: "${TELEGRAM_BOT_TOKEN}"
        chat_id: ${TELEGRAM_CHAT_ID}
        parse_mode: HTML
        message: |
          ğŸš¨ <b>CRITICAL ALERT</b>
          {{ range .Alerts }}
          âš ï¸ <b>{{ .Labels.alertname }}</b>
          {{ if .Labels.instance }}ğŸ“ <code>{{ .Labels.instance }}</code>{{ end }}
          {{ .Annotations.summary }}
          {{ if .Annotations.description }}<i>{{ .Annotations.description }}</i>{{ end }}
          {{ end }}

  - name: watchdog
    webhook_configs:
      - url: "http://localhost:9999/watchdog"
        send_resolved: false
