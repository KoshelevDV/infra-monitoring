groups:

  # ── PostgreSQL ────────────────────────────────────────────────────────────────
  - name: postgresql
    interval: 30s
    rules:

      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL down: {{ $labels.instance }}"
          description: "postgres_exporter cannot connect to PostgreSQL on {{ $labels.instance }}."

      - alert: PostgreSQLTooManyConnections
        expr: |
          pg_stat_activity_count / pg_settings_max_connections > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL connections high: {{ $labels.instance }} ({{ $value | humanizePercentage }})"
          description: "More than 85% of max_connections in use. Risk of connection exhaustion."

      - alert: PostgreSQLConnectionsExhausted
        expr: |
          pg_stat_activity_count / pg_settings_max_connections > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL connections near limit: {{ $labels.instance }}"
          description: "{{ $value | humanizePercentage }} of max_connections used. New connections may be rejected."

      - alert: PostgreSQLDeadlocksHigh
        expr: rate(pg_stat_database_deadlocks[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL deadlocks on {{ $labels.instance }}/{{ $labels.datname }}"
          description: "{{ $value | humanize }} deadlocks/sec. Check for lock contention."

      - alert: PostgreSQLReplicationLagHigh
        expr: pg_replication_lag > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL replica lag: {{ $labels.instance }} ({{ $value }}s)"
          description: "Replication is {{ $value }}s behind primary."

      - alert: PostgreSQLReplicationLagCritical
        expr: pg_replication_lag > 120
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL replica lag CRITICAL: {{ $labels.instance }} ({{ $value }}s)"
          description: "Replica is {{ $value }}s behind. Risk of data inconsistency."

      - alert: PostgreSQLSlowQueriesHigh
        expr: pg_stat_activity_max_tx_duration > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Long-running query on {{ $labels.instance }}"
          description: "Query running for {{ $value }}s. May indicate lock or performance issue."

      - alert: PostgreSQLTableBloat
        expr: |
          pg_stat_user_tables_n_dead_tup /
          (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup + 1) > 0.2
        for: 60m
        labels:
          severity: warning
        annotations:
          summary: "Table bloat on {{ $labels.instance }}: {{ $labels.relname }}"
          description: "{{ $value | humanizePercentage }} dead tuples. VACUUM may be needed."

  # ── MySQL ─────────────────────────────────────────────────────────────────────
  - name: mysql
    interval: 30s
    rules:

      - alert: MySQLDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MySQL down: {{ $labels.instance }}"

      - alert: MySQLTooManyConnections
        expr: |
          mysql_global_status_threads_connected /
          mysql_global_variables_max_connections > 0.85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL connections high: {{ $labels.instance }}"
          description: "{{ $value | humanizePercentage }} of max_connections used."

      - alert: MySQLSlowQueriesHigh
        expr: rate(mysql_global_status_slow_queries[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL slow queries: {{ $labels.instance }} ({{ $value }}/s)"

      - alert: MySQLReplicationLag
        expr: mysql_slave_status_seconds_behind_master > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MySQL replication lag: {{ $labels.instance }} ({{ $value }}s)"

  # ── MSSQL ─────────────────────────────────────────────────────────────────────
  - name: mssql
    interval: 30s
    rules:

      - alert: MSSQLDown
        expr: mssql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MSSQL down: {{ $labels.instance }}"

      - alert: MSSQLDeadlocksHigh
        expr: rate(mssql_deadlocks[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MSSQL deadlocks: {{ $labels.instance }} ({{ $value }}/s)"

      - alert: MSSQLBlockedProcesses
        expr: mssql_blocked_processes > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MSSQL blocked processes: {{ $labels.instance }} ({{ $value }})"
          description: "{{ $value }} blocked processes. Possible lock contention."
