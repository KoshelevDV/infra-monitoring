groups:

  # ── Nodes ─────────────────────────────────────────────────────────────────────
  - name: kubernetes-nodes
    interval: 30s
    rules:

      - alert: KubernetesNodeNotReady
        expr: kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Kubernetes node NotReady: {{ $labels.node }}"
          description: "Node {{ $labels.node }} has been NotReady for > 5 minutes."

      - alert: KubernetesNodeMemoryPressure
        expr: kube_node_status_condition{condition="MemoryPressure",status="true"} == 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kubernetes node MemoryPressure: {{ $labels.node }}"

      - alert: KubernetesNodeDiskPressure
        expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Kubernetes node DiskPressure: {{ $labels.node }}"

  # ── Pods ──────────────────────────────────────────────────────────────────────
  - name: kubernetes-pods
    interval: 30s
    rules:

      - alert: KubernetesPodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Pod crash-looping: {{ $labels.namespace }}/{{ $labels.pod }}"
          description: "Container {{ $labels.container }} is restarting frequently."

      - alert: KubernetesPodNotReady
        expr: |
          kube_pod_status_phase{phase=~"Pending|Unknown"} == 1
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Pod stuck: {{ $labels.namespace }}/{{ $labels.pod }} ({{ $labels.phase }})"

      - alert: KubernetesPodOOMKilled
        expr: kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Pod OOMKilled: {{ $labels.namespace }}/{{ $labels.pod }}"
          description: "Container {{ $labels.container }} was killed due to OOM. Consider increasing memory limits."

  # ── Deployments ───────────────────────────────────────────────────────────────
  - name: kubernetes-deployments
    interval: 30s
    rules:

      - alert: KubernetesDeploymentReplicasMismatch
        expr: |
          kube_deployment_spec_replicas != kube_deployment_status_available_replicas
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Deployment replicas mismatch: {{ $labels.namespace }}/{{ $labels.deployment }}"
          description: "Desired {{ $labels.spec_replicas }} replicas, available {{ $labels.available_replicas }}."

      - alert: KubernetesDeploymentNotAvailable
        expr: |
          kube_deployment_status_available_replicas == 0
          and kube_deployment_spec_replicas > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Deployment has 0 available replicas: {{ $labels.namespace }}/{{ $labels.deployment }}"

  # ── Storage ───────────────────────────────────────────────────────────────────
  - name: kubernetes-storage
    interval: 60s
    rules:

      - alert: KubernetesPVCPending
        expr: kube_persistentvolumeclaim_status_phase{phase="Pending"} == 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PVC stuck in Pending: {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }}"

      - alert: KubernetesPVCStorageLow
        expr: |
          (kubelet_volume_stats_available_bytes / kubelet_volume_stats_capacity_bytes) * 100 < 15
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PVC storage low: {{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }} ({{ $value | printf \"%.1f\" }}% free)"

  # ── Jobs ──────────────────────────────────────────────────────────────────────
  - name: kubernetes-jobs
    interval: 60s
    rules:

      - alert: KubernetesJobFailed
        expr: kube_job_status_failed > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Kubernetes job failed: {{ $labels.namespace }}/{{ $labels.job_name }}"
