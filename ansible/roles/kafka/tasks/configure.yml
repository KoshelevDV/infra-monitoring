---
# ── TLS keystore/truststore ────────────────────────────────────────────────────
- name: Copy TLS keystore
  ansible.builtin.copy:
    src: "{{ kafka_ssl_keystore_src }}"
    dest: "{{ kafka_tls_dir }}/kafka.keystore.jks"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0640"
  when:
    - kafka_security_protocol == 'SASL_SSL'
    - kafka_ssl_keystore_src != ""
  notify: Restart kafka

- name: Copy TLS truststore
  ansible.builtin.copy:
    src: "{{ kafka_ssl_truststore_src }}"
    dest: "{{ kafka_tls_dir }}/kafka.truststore.jks"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0640"
  when:
    - kafka_security_protocol == 'SASL_SSL'
    - kafka_ssl_truststore_src != ""
  notify: Restart kafka

# ── JAAS config (SASL) ────────────────────────────────────────────────────────
- name: Deploy JAAS config
  ansible.builtin.template:
    src: kafka_jaas.conf.j2
    dest: "{{ kafka_config_dir }}/kafka_jaas.conf"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0640"
  when: kafka_security_protocol != 'PLAINTEXT'
  no_log: true
  notify: Restart kafka

# ── server.properties ─────────────────────────────────────────────────────────
- name: Deploy server.properties
  ansible.builtin.template:
    src: server.properties.j2
    dest: "{{ kafka_config_dir }}/server.properties"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0640"
  notify: Restart kafka

# ── JVM / Environment ─────────────────────────────────────────────────────────
- name: Deploy kafka environment file
  ansible.builtin.template:
    src: kafka-env.sh.j2
    dest: "{{ kafka_config_dir }}/kafka-env.sh"
    owner: "{{ kafka_user }}"
    group: "{{ kafka_group }}"
    mode: "0640"
  notify: Restart kafka

# ── KRaft: format storage (только один раз) ───────────────────────────────────
- name: Check if KRaft storage already formatted
  ansible.builtin.stat:
    path: "{{ kafka_data_dir }}/meta.properties"
  register: kraft_meta

- name: Generate cluster ID (if not set and not formatted)
  ansible.builtin.command:
    cmd: "{{ kafka_install_dir }}/bin/kafka-storage.sh random-uuid"
  register: kafka_generated_cluster_id
  changed_when: false
  when:
    - not kraft_meta.stat.exists
    - kafka_cluster_id == ""

- name: Set cluster_id fact
  ansible.builtin.set_fact:
    kafka_effective_cluster_id: >-
      {{ kafka_cluster_id if kafka_cluster_id != '' else kafka_generated_cluster_id.stdout | trim }}
  when: not kraft_meta.stat.exists

- name: Format KRaft storage
  ansible.builtin.command:
    cmd: >
      {{ kafka_install_dir }}/bin/kafka-storage.sh format
      --config {{ kafka_config_dir }}/server.properties
      --cluster-id {{ kafka_effective_cluster_id }}
      --ignore-formatted
  become_user: "{{ kafka_user }}"
  when: not kraft_meta.stat.exists
  notify: Restart kafka

# ── Systemd ───────────────────────────────────────────────────────────────────
- name: Deploy kafka systemd service
  ansible.builtin.template:
    src: kafka.service.j2
    dest: /etc/systemd/system/kafka.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart kafka

- name: Enable and start kafka
  ansible.builtin.systemd:
    name: kafka
    enabled: true
    state: started
    daemon_reload: true

- name: Allow kafka client port in UFW
  community.general.ufw:
    rule: allow
    port: "{{ kafka_client_port }}"
    proto: tcp
    comment: "Apache Kafka client"
  when: ansible_facts.services['ufw.service'] is defined
  ignore_errors: true
